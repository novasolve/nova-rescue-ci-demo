name: Nova CI-Rescue Demo

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

jobs:
  test-and-auto-fix:
    runs-on: ubuntu-latest
    environment: Secrets
    permissions:
      contents: write # For pushing fixes
      pull-requests: write # For creating PRs
      issues: write # For commenting on issues

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better diff generation

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-json-report

      - name: Run initial tests
        id: initial-tests
        continue-on-error: true
        run: |
          echo "Running initial test suite..."
          pytest tests/ -v --tb=short > test_results.txt 2>&1 || echo "TESTS_FAILED=true" >> $GITHUB_OUTPUT
          cat test_results.txt

      - name: Install Nova CI-Rescue if tests failed
        if: steps.initial-tests.outputs.TESTS_FAILED == 'true'
        run: |
          echo "Installing Nova CI-Rescue..."
          pip install --no-cache-dir --force-reinstall git+https://github.com/novasolve/ci-auto-rescue.git@demo/latest

      - name: Configure Git for commits
        if: steps.initial-tests.outputs.TESTS_FAILED == 'true'
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions (Nova CI-Rescue)"

      - name: Setup Nova environment
        if: steps.initial-tests.outputs.TESTS_FAILED == 'true'
        run: |
          # Set model names from secrets or use defaults
          echo "NOVA_DEFAULT_LLM_MODEL=${{ secrets.NOVA_DEFAULT_LLM_MODEL || 'gpt-4o' }}" >> $GITHUB_ENV
          echo "NOVA_PR_LLM_MODEL=${{ secrets.NOVA_PR_LLM_MODEL || 'gpt-4o' }}" >> $GITHUB_ENV
          echo "NOVA_RUN_DEMOS=${{ secrets.NOVA_RUN_DEMOS || 'both' }}" >> $GITHUB_ENV

      - name: Run Nova Auto-Fix if tests failed
        if: steps.initial-tests.outputs.TESTS_FAILED == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          NOVA_DEFAULT_LLM_MODEL: ${{ env.NOVA_DEFAULT_LLM_MODEL }}
          NOVA_PR_LLM_MODEL: ${{ env.NOVA_PR_LLM_MODEL }}
          NOVA_RUN_DEMOS: ${{ env.NOVA_RUN_DEMOS }}
        run: |
          echo "Tests failed! Running Nova CI-Rescue to auto-fix..."
          echo "Using models: Default=${NOVA_DEFAULT_LLM_MODEL}, PR=${NOVA_PR_LLM_MODEL}"
          echo "Running demos: ${NOVA_RUN_DEMOS}"
          nova fix . --ci

      - name: Remove BUG comments from fixed code
        if: steps.initial-tests.outputs.TESTS_FAILED == 'true'
        run: |
          # Check if Nova made any changes first
          if [ -n "$(git diff --name-only)" ]; then
            echo "Nova made changes, checking for BUG comments..."
            
            # More aggressive BUG comment removal
            echo "Removing any BUG comments from fixed code..."
            # Remove full lines that contain only BUG comments
            find src -name "*.py" -exec sed -i '/^\s*# BUG:/d' {} + 2>/dev/null || true
            # Remove inline BUG comments while preserving the code
            find src -name "*.py" -exec sed -i 's/\s*# BUG:.*$//' {} + 2>/dev/null || true
            # Remove any variations of BUG comments
            find src -name "*.py" -exec sed -i 's/\s*#\s*BUG:.*$//' {} + 2>/dev/null || true
            # Also handle case variations
            find src -name "*.py" -exec sed -i 's/\s*# [Bb][Uu][Gg]:.*$//' {} + 2>/dev/null || true
            
            # Check if we removed any comments
            if [ -n "$(git diff --name-only)" ]; then
              echo "BUG comments removed"
              git add -A
              git commit -m "Remove BUG comments from Nova fixes" || true
            else
              echo "No BUG comments found to remove"
            fi
          else
            echo "Nova didn't make any changes, skipping BUG comment removal"
          fi

      - name: Push Nova's fixes back to PR
        if: steps.initial-tests.outputs.TESTS_FAILED == 'true'
        run: |
          # Check if Nova made any changes or if we removed BUG comments
          if [ -n "$(git status --porcelain)" ] || [ -n "$(git diff HEAD^ HEAD --name-only 2>/dev/null)" ]; then
            echo "Changes detected, pushing to PR..."
            git push origin HEAD:${{ github.head_ref }}
            echo "âœ… Pushed Nova's fixes (without BUG comments) to PR"
          else
            echo "No changes to push"
          fi

      - name: Run tests after fix
        if: steps.initial-tests.outputs.TESTS_FAILED == 'true'
        run: |
          echo "Running tests after Nova fix..."
          pytest tests/ -v

      - name: Upload Nova artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nova-artifacts
          path: |
            .nova/
            *.log
            nova-*.log
            telemetry/
          retention-days: 7
          if-no-files-found: ignore
